{% extends "Base.html" %}
{% load bootstrap_toolkit %}
{% load staticfiles %}

{% block scripts_and_styles %}
<script src="{% static 'smo-treeview/smo.treeview-test.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'smo-treeview/smo.treeview.css' %}">
<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://dygraphs.com/dygraph-dev.js"></script>
<script type="text/javascript" src="http://cavorite.com/labs/js/dygraphs-export/dygraph-extra.js"></script>

<!-- http://cavorite.com/labs/js/dygraphs-export/ -->

<script>
	google.load('visualization', '1.0', {'packages':["corechart", "table", "controls"]});

	angular.module('testApp', ['ui.bootstrap', 'angularTreeview'])
	.controller('testController', [ '$scope', '$http', '$window', function($scope, $http, $window) {
		
// 		$scope.activeTabId = "";		
// 		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
// 			  $scope.activeTabId = e.target.id; // activated tab
// // 			  e.relatedTarget // previous tab
// 			});
		
		$scope.tableLoaded = false;
		$scope.dsetName = "";
		
		$scope.initTable = function(){			
			$scope.tableArray = [];
			$scope.columnNames = [];
			$scope.columnNames.push($scope.columnTable.columns[0].name);
			for (i=0; i<$scope.columnTable.columns.length; i++){
				$scope.columnNames.push($scope.columnTable.columns[i].name);
			}
			
			$scope.tableArray.push($scope.columnNames);
			for (i=0; i<$scope.columnTable.data.length; i++){
				$scope.tableArray.push($scope.columnTable.data[i]);
				$scope.tableArray[i+1].unshift($scope.columnTable.data[i][0]);
			}
			
			$scope.allChecked = true;
			$scope.visibilityArray = [];
			for (i=0; i<$scope.tableArray[0].length; i++){				
				$scope.visibilityArray.push(true);
			}
			
			$scope.data = google.visualization.arrayToDataTable($scope.tableArray);
			
// 			var formatter = new google.visualization.NumberFormat({pattern: '###.###'});
// 			for (i=0; i<$scope.columnTable.columns.length; i++){
// 				formatter.format($scope.data, i);
// 	
			$scope.tableView = new google.visualization.DataView($scope.data);
			$scope.drawTableView();
			$scope.chart1 = new Dygraph(document.getElementById('dygraphs'), $scope.tableArray.slice(1),
					{
						labels: $scope.tableArray[0],
						labelsDiv: 'dylegend',
						labelsDivWidth: 150,
						labelsSeparateLines: true,
						width: 900,
						height: 500,
						title: $scope.dsetName,
						xlabel: $scope.tableArray[0][0],
					});
			
			$('#plotTab').tab('show');
		}
			

		$scope.setToAll = function(){
			for (i=0; i<$scope.visibilityArray.length; i++){
				$scope.visibilityArray[i] = $scope.allChecked;
			}
// 			if ($scope.allChecked == false){
// 				$scope.visibilityArray[$scope.xAxis] = true;
// 			}
			
			for (i=1; i<$scope.visibilityArray.length; i++){
				$scope.chart1.setVisibility(i-1, $scope.visibilityArray[i]);
			}
			$scope.drawTableView();	
		}
		
		$scope.updateChecked = function(i){		
			$scope.chart1.setVisibility(i-1, $scope.visibilityArray[i]);
			$scope.drawTableView();	
		}
		
		$scope.updateXaxis = function(xAxis){
			console.log(xAxis);
			for (i=0; i<$scope.tableArray[0].length; i++){
				var elem = $scope.tableArray[i][xAxis];
				$scope.tableArray[i][0] = elem;
			}
			
// 			delete $scope.chart1;
// 			$scope.plotData();

			$scope.chart1.updateOptions({
				file: $scope.tableArray.slice(1),
				labels: $scope.tableArray[0],
				xlabel: $scope.tableArray[0][0]
				
			});	

// 			$scope.chart1 = new Dygraph(document.getElementById('dygraphs'), $scope.tableArray.slice(1),
// 					{
// 						labels: $scope.tableArray[0],
// 						labelsDiv: 'dylegend',
// 						labelsDivWidth: 150,
// 						labelsSeparateLines: true,
// 						width: 900,
// 						height: 500,
// 						title: $scope.dsetName,
// 						xlabel: $scope.tableArray[0][0],
// 					});
		}
		
		$scope.drawTableView = function (){
			var viewCloumns = [];
			viewCloumns.push(0);
			for (i=1; i<$scope.visibilityArray.length; i++){
				if ($scope.visibilityArray[i] == true){
					viewCloumns.push(i);
				}
			}
			$scope.tableView.setColumns(viewCloumns);		
			var tableView = new google.visualization.Table(document.getElementById('view_div'));
			tableView.draw($scope.tableView, {showRowNumber: true, sort:'disable', page:'enable', pageSize:20});
		}
		
		$scope.updatePlot = function(){
			$scope.chart1.updateOptions({});
			
		}
		
		$scope.exportToPNG = function(){
			var img = document.getElementById('demoimg');
			Dygraph.Export.asPNG($scope.chart1, img);
			var link = document.createElement("a");			
		 	if(link.download !== undefined) { // feature detection
		 	  // Browsers that support HTML5 download attribute
		 	  link.setAttribute("href", img.src);
		 	  link.setAttribute("download", "Dugraph img");
		 	 } else {
		 		// it needs to implement server side export
				//link.setAttribute("href", "http://www.example.com/export");
		 		  alert("Needs to implement server side export");
		 		  return;
		 	}
		 	document.body.appendChild(link);
		 	link.click();
		}
		
		$scope.checkboxStyle = function(i){
			return {color: $scope.chart1.getPropertiesForSeries($scope.chart1.getLabels()[i]).color};
		}
		
// 		$scope.zoomBack = function(){
// 			var prevZoomedValues = $scope.ZoomedValuesArray.pop();
// 			$scope.chart1.updateOptions({
// 		          dateWindow: [prevZoomedValues[0], prevZoomedValues[1]],
// 		          valueRange: [prevZoomedValues[2], prevZoomedValues[3]]
// 		        });
// 			$scope.timesZoomed -= 1;
// 			$scope.plotData();
// 		}
		
// 		$scope.clearGraph = function(context, area, chart){
// 			if (typeof(g) == 'undefined') return;
// 			chart.updateOptions({});
// 		}	
		
// 		$scope.plotData = function(){
// 			$scope.chart1.draw($scope.plotView, {
// 				labelsDiv: 'dylegend',
// 				labelsDivWidth: 150,
// 				labelsSeparateLines: true,
// 				width: 900,
// 				height: 500,
// 				title: $scope.dsetName,
// 				xlabel: $scope.tableArray[0][$scope.xAxis],
// 				underlayCallback: $scope.setPlotView,
// 				drawCallback: function(chart, initial) {
// 					if (!$scope.timesZoomed && chart){
						
// 						$scope.chart = chart;
// 						$scope.ZoomedValuesArray = [];
// 				      var minDate = chart.xAxisRange()[0];
// 				      var maxDate = chart.xAxisRange()[1];
// 				      var minValue = chart.yAxisRange()[0];
// 				      var maxValue = chart.yAxisRange()[1];
// 				      $scope.ZoomedValuesArray.push(minDate, maxDate, minValue, maxValue);
// // 				      console.log($scope.ZoomedValuesArray);
// 					}					
// 	            },
// 				zoomCallback: function(minDate, maxDate, valueRange) {
// 					console.log(minDate, maxDate, valueRange);
				
// 					$scope.ZoomedValuesArray.push(minDate, maxDate, valueRange[0], valueRange[1]);
// 					$scope.timesZoomed += 1;
// 		        },
// 			});
// 			$scope.chart2 = new Dygraph(document.getElementById('dygraphs2'), "Date,Series1,Series2\n" + "1247382000,100,200\n" + "1247986800,150,201\n",
// 					{});
//  			$scope.chart2.setVisibility(1, false);
// 			$scope.chart2.draw()
// 			}
			
		
	}]);

</script>
{% endblock %}

{% block content %}
<div ng-app="testApp" ng-controller="testController">
	<div class="container">
		<!-- Nav tabs -->
		<ul class="nav nav-tabs" role="tablist" id="myTab">
		  <li class="active"><a id="explorerTab" data-target="#tree" role="tab" data-toggle="tab">Explorer</a></li>
		  <li ng-show="tableLoaded" ><a id="plotTab" data-target="#plot" role="tab" data-toggle="tab" ng-click="updatePlot()">Plot</a></li>
		  <li ng-show="tableLoaded" ><a id="tableTab" data-target="#view" role="tab" data-toggle="tab" ng-click="drawTableView()">Table</a></li>
		</ul>

		<!-- Tab panes -->
		<div class="tab-content">
		  <div class="tab-pane active" id="tree">
			  	<br>
			  	<div style="text-align: left; font-weight: bold; font-size: medium;">Explore data file:</div>
			  	<br>
			  	<smo-hdf-browser tree-id="hdfView"></smo-hdf-browser>
		  </div>
		  <div class="tab-pane" id="plot">
				<div>
					<input type="checkbox" ng-model="allChecked" ng-change="setToAll()"></input>
					<span>Check/Uncheck all</span>
				</div>
				<div style="width: 70%;">		  				
					<div style="display:inline-block;" ng-repeat="columnName in columnNames.slice(1) track by $index">
						<input type="checkbox" ng-model="visibilityArray[$index+1]" ng-change="updateChecked($index+1)"></input>
						<span ng-style="checkboxStyle($index+1)" ng-bind="columnName"></span>
						&nbsp&nbsp&nbsp&nbsp&nbsp
					</div>
				</div>
				<div>	<!-- Not working -->		
					Set X axis:
					<select ng-options="columnNames.slice(1).indexOf(columnName)+1 as columnName for columnName in columnNames.slice(1)" ng-model="xAxis" ng-change="updateXaxis(xAxis)">
					</select>
				</div>				
				<div>
					<br>
					<button class ="btn btn-default" ng-click="exportToPNG()">Export to image</button>
					<img id="demoimg" hidden>
				</div>
				<div>						  
					<div id="dygraphs" style="display:inline-block; float: left;"></div>	
					<div id="dylegend" style="display:inline-block; float:right;"></div>
				</div>
				
				
				

		  </div>
		  <div class="tab-pane" id="view">
				<div>
					<input type="checkbox" ng-model="allChecked" ng-change="setToAll()"></input>
					<span>Check/Uncheck all</span>
				</div>
				<div style="width: 70%;">		  				
					<div style="display:inline-block;" ng-repeat="columnName in columnNames.slice(1) track by $index">
						<input type="checkbox" ng-model="visibilityArray[$index+1]" ng-change="updateChecked($index+1)"></input>
						<span ng-bind="columnName"></span>
						&nbsp&nbsp&nbsp&nbsp&nbsp
					</div>
				</div>			  
				<div id="view_div"></div>	
		 </div>
		</div>
	</div>
</div>
{% endblock %}