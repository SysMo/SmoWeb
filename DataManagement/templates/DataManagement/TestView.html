{% extends "Base.html" %}
{% load bootstrap_toolkit %}
{% load staticfiles %}

{% block scripts_and_styles %}
<script src="{% static 'smo-treeview/smo.treeview-test.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'smo-treeview/smo.treeview.css' %}">
<!--Load the AJAX API-->
<script type="text/javascript" src="https://www.google.com/jsapi"></script>
<script type="text/javascript" src="http://dygraphs.com/dygraph-dev.js"></script>
<script>
	google.load('visualization', '1.0', {'packages':["corechart", "table", "controls"]});

	angular.module('testApp', ['ui.bootstrap', 'angularTreeview'])
	.controller('testController', [ '$scope', '$http', '$window', function($scope, $http, $window) {
		
		$scope.activeTabId = "";		
		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			  $scope.activeTabId = e.target.id; // activated tab
// 			  e.relatedTarget // previous tab
			});
		
		$scope.tableLoaded = false;
		$scope.dsetName = "";
		
		$scope.initTable = function(){
			$scope.allChecked = true;
			
			$scope.columnsShow = [];
			for (i=0; i<$scope.columnTable.columns.length; i++){
				$scope.columnsShow[i] = true;
			}
			
			$scope.xAxis = 0;
			
			$scope.timesZoomed = 0;
			$scope.ZoomedValuesArray = [];
					
			$scope.tableArray = [];
			var columnNames = [];
			for (i=0; i<$scope.columnTable.columns.length; i++){
				columnNames.push($scope.columnTable.columns[i].name);
			}
			
			$scope.tableArray.push(columnNames);
			for (i=0; i<$scope.columnTable.data.length; i++){
				$scope.tableArray.push($scope.columnTable.data[i]);				
			}
			
			
			$scope.data = google.visualization.arrayToDataTable($scope.tableArray);
			
// 			var formatter = new google.visualization.NumberFormat({pattern: '###.###'});
// 			for (i=0; i<$scope.columnTable.columns.length; i++){
// 				formatter.format($scope.data, i);
// 			}
			$scope.view = new google.visualization.DataView($scope.data);
			
			$scope.plotData();
			$('#plotTab').tab('show');
		}
		
		
		
		$scope.setView = function (){
			var viewCloumns = [];
			for (i=0; i<$scope.columnsShow.length; i++){
				if ($scope.columnsShow[i] == true){
					viewCloumns.push(i);
				}
			}
			$scope.view.setColumns(viewCloumns);
		}
		
		$scope.setToAll = function(){
			for (i=0; i<$scope.columnsShow.length; i++){
				$scope.columnsShow[i] = $scope.allChecked;
			}
			if ($scope.allChecked == false){
				$scope.columnsShow[$scope.xAxis] = true;
			}
			$scope.setView();
			$scope.drawView();			
			
		}
		
		$scope.updateChecked = function(){
			$scope.allChecked = false;
			$scope.setView();
			$scope.drawView();		
		}
		
		$scope.setToAllPlot = function(){
			for (i=0; i<$scope.columnsShow.length; i++){
				$scope.columnsShow[i] = $scope.allChecked;
			}
			if ($scope.allChecked == false){
				$scope.columnsShow[$scope.xAxis] = true;
			}
			$scope.setPlotView();
			$scope.plotData();
		}
		
		$scope.updateCheckedPlot = function(){
			$scope.allChecked = false;
			$scope.setPlotView();
			$scope.plotData();
		}
		
		$scope.updateXaxis = function(){
			$scope.columnsShow[$scope.xAxis] = true;
			$scope.setPlotView();
			$scope.plotData();
		}
		
		$scope.setPlotView = function(){
			var viewCloumns = [];
			viewCloumns.push($scope.xAxis);

			for (i=0; i<$scope.tableArray[0].length; i++){				
				if (i != $scope.xAxis){
					if ($scope.columnsShow[i] == true){
						viewCloumns.push(i);				
					}
				}
			}
			console.log(viewCloumns);
 			$scope.view.setColumns(viewCloumns);
 			
		}
		
//  		$scope.drawTable = function (){						
//  			var table = new google.visualization.Table(document.getElementById('table_div'));
//  			table.draw($scope.data, {showRowNumber: true, sort:'disable', page:'enable', pageSize:20});			
//  		}
		
		$scope.drawView = function (){
			$scope.setView();
			var tableView = new google.visualization.Table(document.getElementById('view_div'));
			tableView.draw($scope.view, {showRowNumber: true, sort:'disable', page:'enable', pageSize:20});
		}
		
// 		$scope.zoomBack = function(){
// 			var prevZoomedValues = $scope.ZoomedValuesArray.pop();
// 			$scope.chart1.updateOptions({
// 		          dateWindow: [prevZoomedValues[0], prevZoomedValues[1]],
// 		          valueRange: [prevZoomedValues[2], prevZoomedValues[3]]
// 		        });
// 			$scope.timesZoomed -= 1;
// 			$scope.plotData();
// 		}
		
		$scope.setArgument = function(i){
			console.log("X is:" + i);
			checkboxStyle={'color': 'red'};
		}
		
		$scope.chart1 = new Dygraph.GVizChart(
				document.getElementById('dygraphs'));
		
// 		$scope.clearGraph = function(context, area, chart){
// 			if (typeof(g) == 'undefined') return;
// 			chart.updateOptions({});
// 		}
		
		$scope.plotData = function(){
			$scope.chart1.draw($scope.view, {
				labelsDiv: 'dylegend',
				labelsDivWidth: 150,
				labelsSeparateLines: true,
				width: 900,
				height: 500,
				title: $scope.dsetName,
				xlabel: $scope.tableArray[0][$scope.xAxis],
				underlayCallback: $scope.setPlotView,
				drawCallback: function(chart, initial) {
					if (!$scope.timesZoomed && chart){
						
						$scope.chart = chart;
						$scope.ZoomedValuesArray = [];
				      var minDate = chart.xAxisRange()[0];
				      var maxDate = chart.xAxisRange()[1];
				      var minValue = chart.yAxisRange()[0];
				      var maxValue = chart.yAxisRange()[1];
				      $scope.ZoomedValuesArray.push(minDate, maxDate, minValue, maxValue);
// 				      console.log($scope.ZoomedValuesArray);
					}					
	            },
				zoomCallback: function(minDate, maxDate, valueRange) {
					console.log(minDate, maxDate, valueRange);
				
					$scope.ZoomedValuesArray.push(minDate, maxDate, valueRange[0], valueRange[1]);
					$scope.timesZoomed += 1;
		        },
	            clickCallback: function(e, x, points){
	            	if($scope.timesZoomed == 0) return;
	            	var prevZoomedValues = $scope.ZoomedValuesArray.pop();
	            	console.log(prevZoomedValues);
	            	$scope.chart.updateOptions({
	    		          dateWindow: [prevZoomedValues[0], prevZoomedValues[1]],
	    		          valueRange: [prevZoomedValues[2], prevZoomedValues[3]]
	    		        });
	    			$scope.timesZoomed -= 1;
	            }
			});
			}
			
		
	}]);

</script>
{% endblock %}

{% block content %}
<div ng-app="testApp" ng-controller="testController">
	<div class="container">
		<!-- Nav tabs -->
		<ul class="nav nav-tabs" role="tablist" id="myTab">
		  <li class="active"><a id="explorerTab" data-target="#tree" role="tab" data-toggle="tab">Explorer</a></li>
		  <li ng-show="tableLoaded" ><a id="plotTab" data-target="#plot" role="tab" data-toggle="tab" ng-click="plotData()">Plot</a></li>
		  <li ng-show="tableLoaded" ><a id="viewTab" data-target="#view" role="tab" data-toggle="tab" ng-click="drawView()">Table</a></li>
		</ul>

		<!-- Tab panes -->
		<div class="tab-content">
		  <div class="tab-pane active" id="tree">
			  	<br>
			  	<div style="text-align: left; font-weight: bold; font-size: medium;">Explore data file:</div>
			  	<br>
			  	<smo-hdf-browser tree-id="hdfView"></smo-hdf-browser>
		  </div>
		  <div class="tab-pane" id="plot">
				<div ng-bind="dsetName" style="font-weight: bold; font-size: large;"></div>
				<div>
					<input type="checkbox" ng-model="allChecked" ng-change="setToAllPlot()"></input>
					<span>Check/Uncheck all</span>
				</div>
				<div style="width: 70%;">		  				
					<div style="display:inline-block;" ng-repeat="columnName in tableArray[0] track by $index">
						<input type="checkbox" ng-model="columnsShow[$index]" ng-change="updateCheckedPlot()"></input>
						<span ng-style="checkboxStyle" ng-bind="columnName"></span>
						&nbsp&nbsp&nbsp&nbsp&nbsp
					</div>
				</div>
				<div>
					Set X axis:
					<select ng-options="tableArray[0].indexOf(columnName) as columnName for columnName in tableArray[0]" ng-model="xAxis" ng-change="updateXaxis()">
					</select>
				</div>
				<div>			  
				<div id="dygraphs" style="display:inline-block; float: left;"></div>	
				<div id="dylegend" style="display:inline-block; float:right;"></div>
				</div>	

		  </div>
		  <div class="tab-pane" id="view">
		  		<div ng-bind="dsetName" style="font-weight: bold; font-size: large;"></div>
				<div>
					<input type="checkbox" ng-model="allChecked" ng-change="setToAll()"></input>
					<span>Check/Uncheck all</span>
				</div>
				<div style="width: 70%;">		  				
					<div style="display:inline-block;" ng-repeat="columnName in tableArray[0] track by $index">
						<input type="checkbox" ng-model="columnsShow[$index]" ng-change="updateChecked()"></input>
						<span ng-bind="columnName"></span>
						&nbsp&nbsp&nbsp&nbsp&nbsp
					</div>
				</div>				  
				<div id="view_div"></div>	
		 </div>
		</div>
	</div>
</div>
{% endblock %}