{% extends "Base.html" %}
{% load bootstrap_toolkit %}
{% load staticfiles %}

{% block scripts_and_styles %}
<script src="{% static 'SmoUtil.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/SmoInputOutputView.css' %}">
<script>
angular.module('FlowResistance', ['ui.bootstrap', 'smo'])
	.config(['$httpProvider', function($httpProvider) {
	    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
	    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
	}])
	.controller('FlowResistanceController', 
		['$scope', '$http', 'smoJson', function($scope, $http, smoJson) {
//  		$scope.inputs = { autoFetch : true, dataUrl: '/ThermoFluids/FlowResistance/', action: 'getInputs'};
//  		$scope.outputs = { dataUrl: '/ThermoFluids/FlowResistance/', action: 'compute'};
		$scope.action = 'getInputs';
		$scope.inputs = {}
		$scope.outputs = {}
		$scope.fetchData = function(parameters) {
			$scope.inputs.obtained = false;
			$scope.outputs.obtained = false;
			if ($scope.action=='getInputs'){
				$scope.inputs.loading = true;
			} else if ($scope.action=='compute'){
				$scope.outputs.loading = true;
			}			
			var parameters = parameters || {};				
			$http({
		        method  : 'POST',
		        url     : '/ThermoFluids/FlowResistance/',
		        data    : {action : $scope.action, parameters: parameters},
		        headers : { 'Content-Type': 'application/x-www-form-urlencoded' }, // set the headers so angular passing info as form data (not request payload)
		        transformResponse: [smoJson.transformResponse]
			})
		    .success(function(data) {
		    	if ($scope.action=='getInputs'){	
		    		$scope.inputs.loading = false;
		    		$scope.inputs.errStatus = data.errStatus;
			    	if (!$scope.inputs.errStatus) {
				    	$scope.inputs.obtained = true;
				    	$scope.inputs.data = data;
			    	}
			    	else {
			    		$scope.inputs.obtained = false;
			    		$scope.outputs.obtained = false;
				    	$scope.error = data.error || 'Error loading!';
			    	}
		    	} else if ($scope.action=='compute'){
		    		$scope.outputs.loading = false;
		    		$scope.outputs.errStatus = data.errStatus;
			    	if (!$scope.outputs.errStatus) {
				    	$scope.outputs.obtained = true;
				    	$scope.inputs.obtained = true;
				    	$scope.outputs.data = data;
			    	}
			    	else {
			    		$scope.outputs.obtained = false;
			    		$scope.inputs.obtained = true;
				    	$scope.error = data.error || 'Error loading!';
			    	}
		    	}		    	
		    });
		}
		$scope.fetchData();
		$scope.compute = function() {
			$scope.action = 'compute';
			$scope.fetchData($scope.inputs.data.values);
		}
		
	}]);
</script>
{% endblock %}

{% block pills %}
	<li class="active" role="presentation"><a id="calcTab" data-target="#calculator" role="tab" data-toggle="tab">Calculator</a></li>
	<li role="presentation"><a id="docTab" data-target="#doc" role="tab" data-toggle="tab">Doc</a></li>
{% endblock %}

{% block content %}
<div ng-app="FlowResistance" ng-controller="FlowResistanceController">
	<div class="tab-content">
		<div class="tab-pane active page-container" id="calculator">
			<h1 class="title">Pressure losses in pipe flow</h1>
			<div class="title-figure">
				<img src="{% static 'ThermoFluids/StraightPipe.svg' %}" type="image/svg+xml"></object>
			</div>
			{% verbatim %}
			<div ng-if="inputs.loading"><h2 class="loading">Loading...</h2></div>
			<div ng-if="inputs.errStatus">
				<div class="alert alert-danger" role="alert">
				  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
				  <span class="sr-only">Error:</span>
				  {{error}}
				</div>
			</div>				
			<div ng-show="inputs.obtained">
				<div class="section"><h1>Input data</h1></div>
				<div ng-form name="myForm">
					<div ng-repeat="fieldgroup in inputs.data.definitions[0].groups" 
							smo-field-group="fieldgroup"
							view-type="'input'" 
							smo-data-source="inputs.data.values">
					</div>
				</div>
				<button ng-disabled="!myForm.$valid" class="btn btn-default" ng-click="compute()">Compute</button>
			</div>
			<div ng-if="outputs.loading"><h2 class="loading">Loading...</h2></div>
			<div ng-if="outputs.errStatus">
				<div class="alert alert-danger" role="alert">
				  <span class="glyphicon glyphicon-exclamation-sign" aria-hidden="true"></span>
				  <span class="sr-only">Error:</span>
				  {{error}}
				</div>
			</div>
			<div ng-show="outputs.obtained">
				<div class="section"><h1>Output data</h1></div>
				<div smo-field-group="fieldgroup" ng-repeat="fieldgroup in outputs.data.definitions[0].groups" view-type="'output'" smo-data-source="outputs.data.values"></div>
			</div>
			{% endverbatim %}
		</div>
		<div class="tab-pane" id="doc">
			<div class="docview">
				{% include 'documentation/html/FlowResistance.html' %}
			</div>
		</div>
	</div>
</div>
{% endblock %}


