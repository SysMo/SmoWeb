{% extends "Base.html" %}
{% load bootstrap_toolkit %}
{% load staticfiles %}

{% block scripts_and_styles %}
<script src="{% static 'SmoUtil.js' %}"></script>
<link rel="stylesheet" type="text/css" href="{% static 'css/SmoInputOutputView.css' %}">

<script type="text/javascript" src="http://dygraphs.com/dygraph-dev.js"></script>
<script type="text/javascript" src="http://cavorite.com/labs/js/dygraphs-export/dygraph-extra.js"></script>

<script>
angular.module('FluidPropsCalculator', ['ui.bootstrap', 'smo'])
	.config(['$httpProvider', function($httpProvider) {
	    $httpProvider.defaults.xsrfCookieName = 'csrftoken';
	    $httpProvider.defaults.xsrfHeaderName = 'X-CSRFToken';
	}])
	.controller('FluidPropsController', [ '$scope', '$http', 'ModelCommunicator', function($scope, $http, ModelCommunicator) {
		$scope.activeTabId = "";
		$('a[data-toggle="tab"]').on('shown.bs.tab', function (e) {
			  $scope.activeTabId = e.target.id; // activated tab
// 			  e.relatedTarget // previous tab
			});
		
		$scope.fluidProps = {
			inputs: [{inputCommunicator: new ModelCommunicator()}],
			results: [{resultsCommunicator: new ModelCommunicator()}]
		};
		
		$scope.fluidProps.inputs[0].inputCommunicator.fetchData(
			'getInputs', {});
		
		$scope.compute = function(index) {
			$scope.fluidProps.results[index].resultsCommunicator.fetchData(
				'compute', $scope.fluidProps.inputs[index].inputCommunicator.data.values);
		}
		
		$scope.createNewTab = function() {
			var newInputCommunicator = jQuery.extend(true, {}, $scope.fluidProps.inputs[$scope.fluidProps.inputs.length-1].inputCommunicator);			
			$scope.fluidProps.inputs.push({inputCommunicator : newInputCommunicator});			
			$scope.fluidProps.results.push({resultsCommunicator: new ModelCommunicator()});
			$('#FP' + String($scope.fluidProps.inputs.length-1) + 'Tab').tab('show');
		}
		
		$scope.getTabClass = function(index) {		
			if (index == ($scope.fluidProps.inputs.length-1)) {
				return 'ng-scope active';
			} else {
				return 'ng-scope';
			}
		}
	
		$scope.delLastTab = function() {
			if ($scope.fluidProps.inputs.length == 1){
				return;
			}
			$scope.fluidProps.inputs.pop();
			$scope.fluidProps.results.pop();
			$('#FP' + String($scope.fluidProps.inputs.length) + 'Tab').tab('show');
		}
		
		// Fluids info		
		$scope.fluidInfo = {
			inputCommunicator: new ModelCommunicator()
		};
		
		$scope.fluidInfo.inputCommunicator.fetchData(
			'getFluidInfo', {}, function(comm){
				$scope.fluidInfo.selectedFluid = comm.data[0];
			});
		
		// Saturation properties		
		$scope.saturation = {
			inputCommunicator: new ModelCommunicator(),
			resultsCommunicator: new ModelCommunicator()
		};
		
		$scope.saturation.inputCommunicator.fetchData(
			'getFluidList', {}, function(comm){
				$scope.saturation.selectedFluid = comm.data[0][0];
			});
		
		$scope.plotData = function() {
			$scope.xAxis = 0;
			$scope.chart = new Dygraph(document.getElementById('plot_div'), $scope.saturation.resultsCommunicator.data.array,
					{
						labels: $scope.saturation.resultsCommunicator.data.labels,
						labelsDiv: 'dylegend',
						labelsDivWidth: 150,
						labelsSeparateLines: true,
						width: 700,
						height: 400,
						xlabel: $scope.saturation.resultsCommunicator.data.labels[0],
						ylabel: $scope.saturation.resultsCommunicator.data.labels[1],
						axes : { x : {  logscale : true }}
			        });	
		}
		
		$scope.fetchSaturationData = function (){
			$scope.saturation.resultsCommunicator.fetchData(
					'getSaturationData', {fluidName : $scope.saturation.selectedFluid}, function(comm){
						$scope.plotData();
					});			
		}
}])
</script>
{% endblock %}


{% block pills %}
	<li class="active" role="presentation"><a id="calcTab" data-target="#calculator" role="tab" data-toggle="tab">Calculator</a></li>
	<li role="presentation"> <a id="fluidsTab" data-target="#fluids" role="tab" data-toggle="tab">Fluid info</a></li>
	<li role="presentation"> <a id="saturationTab" data-target="#saturation" role="tab" data-toggle="tab">Saturation</a></li>
	<li role="presentation"> <a id="docTab" data-target="#doc" role="tab" data-toggle="tab">Doc</a></li>
{% endblock %}

{% block content %}
<div ng-app="FluidPropsCalculator" ng-controller="FluidPropsController">
	<div class="tab-content">
		<div class="tab-pane active page-container" id="calculator">		
			<h1 class="title">Fluid properties calculator</h1>
			<div class="title-figure">
				<img src="{% static 'ThermoFluids/StateDiagram3D.svg' %}"></img>
			</div>		
{% verbatim %}	
			<ul class="nav nav-tabs" role="tablist" id="FluidPointTabs">
		  		<li ng-repeat="input in fluidProps.inputs track by $index" ng-class="getTabClass($index)">
			  		<a ng-attr-id="FP{{$index + 1}}Tab" data-target="#FluidPoint{{$index + 1}}" role="tab" data-toggle="tab" >Fluid point {{$index + 1}}</a>			  		
		  		</li>
			  	<li><a data-target="" id="FluidPointNew" ng-click="createNewTab()">+</a></li>
			  	<li><a data-target="" ng-click="delLastTab()">-</a></li>			  	
			</ul>		
			<div class="tab-content">
				<div ng-repeat="input in fluidProps.inputs track by $index" ng-class="'tab-pane '+ getTabClass($index)" id="FluidPoint{{$index + 1}}">					
					<div smo-model-view="fluidPropsInputs" view-type="input" communicator="fluidProps.inputs[$index].inputCommunicator"></div>
					<div class="section" style="margin-left: 20px;"> 		
						<div ng-show="fluidProps.inputs[$index].inputCommunicator.dataReceived"><button ng-disabled="!fluidProps.inputs[$index].inputCommunicator.fieldsValid" 
							 class="btn btn-default" ng-click="compute($index)">Compute</button>
						</div>
					</div>
					<div class="section"> 
						<div smo-model-view="fluidPropsResults" view-type="output" communicator="fluidProps.results[$index].resultsCommunicator"></div>
					</div>
					
										
				</div>
			</div>
{% endverbatim %}
		</div>
		<div class="tab-pane" id="doc">
			<div class="docview">
				{% include 'documentation/html/FluidPropsCalculator.html' %}
			</div>
		</div>
		<div class="tab-pane page-container" id="fluids">
{% verbatim %}	
			<h1 class="title">Fluid information</h1>			
			<div ng-if="fluidInfo.inputCommunicator.loading" class="alert alert-info" role="alert">Loading...</div>
			<div ng-if="fluidInfo.inputCommunicator.commError" class="alert alert-danger" role="alert">Communication error: <span ng-bind="fluidInfo.inputCommunicator.errorMsg"></span></div>
			<div ng-if="fluidInfo.inputCommunicator.serverError" class="alert alert-danger" role="alert">Server error: <span ng-bind="fluidInfo.inputCommunicator.errorMsg"></span></div>
			<div ng-if="fluidInfo.inputCommunicator.dataReceived">
				<div class="section">
					<div class="field-label">Select a fluid:</div>
					<div class="field-select choice">
						<select ng-model="fluidInfo.selectedFluid" ng-options="fluid as fluid.label for fluid in fluidInfo.inputCommunicator.data"></select>
					</div>
				</div>
				
				<div class="section">
					<div style="display: inline-block;" ng-repeat="constant in fluidInfo.selectedFluid.constants.definitions[0].groups">
						<div smo-field-group="constant" view-type="'output'" smo-data-source="fluidInfo.selectedFluid.constants.values">
						</div>
					</div>
				</div>				
				<div class="section">
					<h1>Literature References</h1>				
					<div ng-repeat="pair in fluidInfo.selectedFluid.references" ng-show="pair[1]">
						<span class="label-text">{{pair[0]}}:</span> {{pair[1].author}}, <span class="italic-text">{{pair[1].title}}</span>
					</div>			
				</div>
			</div>
			
		</div>
{% endverbatim %}
		<div class="tab-pane page-container" id="saturation">
			<h1 class="title">Saturation</h1>
			<div ng-if="saturation.inputCommunicator.loading" class="alert alert-info" role="alert">Loading...</div>
			<div ng-if="saturation.inputCommunicator.commError" class="alert alert-danger" role="alert">Communication error: <span ng-bind="saturation.inputCommunicator.errorMsg"></span></div>
			<div ng-if="saturation.inputCommunicator.serverError" class="alert alert-danger" role="alert">Server error: <span ng-bind="saturation.inputCommunicator.errorMsg"></span></div>
			<div ng-if="saturation.inputCommunicator.dataReceived">						
				<div class="section">
					<div class="field-label">Select a fluid:</div>
					<div class="field-select choice">
						<select ng-model="saturation.selectedFluid" ng-options="pair[0] as pair[1] for pair in saturation.inputCommunicator.data"></select>
					</div>
					<div class="field-select choice" style="margin-left: 5px;">
						<button ng-click="fetchSaturationData()">Go!</button>
					</div>
				</div>
			</div>
			<div ng-if="saturation.resultsCommunicator.loading" class="alert alert-info" role="alert">Loading...</div>
			<div ng-if="saturation.resultsCommunicator.commError" class="alert alert-danger" role="alert">Communication error: <span ng-bind="saturation.resultsCommunicator.errorMsg"></span></div>
			<div ng-if="saturation.resultsCommunicator.serverError" class="alert alert-danger" role="alert">Server error: <span ng-bind="saturation.resultsCommunicator.errorMsg"></span></div>
			<div ng-show="saturation.resultsCommunicator.dataReceived">			
				<div style="white-space: nowrap;">
					<div style="display: inline-block;">			  
						<div id="plot_div"></div>
					</div>
					<div style="display: inline-block; vertical-align: top;">
						<div id="dylegend"></div>
					</div>
				</div>  				
			</div>
		</div>
	</div>
</div>
{% endblock %}
